{% extends "base.html" %}

{% block title %}MAC Address Management{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2><i class="fas fa-address-card"></i> MAC Address Management</h2>
    
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <!-- بطاقة إضافة عنوان MAC جديد -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h4><i class="fas fa-plus-circle"></i> Block New MAC Address</h4>
        </div>
        <div class="card-body">
            <form action="/block-mac" method="POST" id="blockForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="mac">MAC Address</label>
                            <input type="text" class="form-control" id="mac" name="mac" 
                                   placeholder="00:11:22:33:44:55 or 00-11-22-33-44-55" required>
                            <small class="form-text text-muted">Supported formats: 00:11:22:33:44:55, 00-11-22-33-44-55, 001122334455</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="reason">Reason (Optional)</label>
                            <input type="text" class="form-control" id="reason" name="reason" 
                                   placeholder="Reason for blocking">
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-ban"></i> Block Address
                    </button>
                    <button type="button" id="checkMacBtn" class="btn btn-info ms-2">
                        <i class="fas fa-search"></i> Check Status
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- جدول العناوين المحظورة -->
    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4><i class="fas fa-list"></i> Blocked MAC Addresses</h4>
            <div>
                <span class="badge bg-light text-dark me-2">
                    Total: {{ mac_list|length }}
                </span>
                <button id="refreshBtn" class="btn btn-sm btn-light">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
        <div class="card-body">
	{% if mac_list %}
	<div class="table-responsive">
    	   <table class="table table-hover" id="macTable">
               <thead class="bg-primary-light text-white">
            	  <tr>
                      <th>MAC Address</th>
                      <th>Reason</th>
                      <th>Date Blocked</th>
                      <th>Actions</th>
            	  </tr>
              </thead>
              <tbody>
            	  {% for mac in mac_list %}
            	  <tr>
                      <td>{{ mac[1] }}</td>
                      <td>{{ mac[2] or 'No reason specified' }}</td>
              	      <td>{{ mac[3] }}</td>
              	      <td>
                    	  <form action="/unblock-mac" method="POST" class="unblock-form" style="display:inline;">
                              <input type="hidden" name="mac" value="{{ mac[1] }}">
                              <button type="submit" class="btn btn-sm btn-outline-primary">
                            	  <i class="fas fa-unlock"></i> Unblock
                              </button>
                    	   </form>
                       </td>
            	   </tr>
            	    {% endfor %}
        	</tbody>
    	    </table>
	</div>
	{% else %}
	<div class="alert alert-info">
    	    No MAC addresses are currently blocked. Add your first MAC address using the form above.
	</div>
	{% endif %}
        </div>
    </div>
</div>

<!-- Modal for Viewing Rules -->
<div class="modal fade" id="rulesModal" tabindex="-1" aria-labelledby="rulesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="rulesModalLabel">IPTables Rules for MAC: <span id="modalMac"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="rulesContent" class="bg-dark text-white p-3 rounded"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-primary-light {
        background-color: #5dade2;
    }
    .table-hover tbody tr:hover {
        background-color: rgba(93, 173, 226, 0.1);
    }
    .btn-outline-primary {
        border-color: #3498db;
        color: #3498db;
    }
    .btn-outline-primary:hover {
        background-color: #3498db;
        color: white;
    }
    .btn-outline-info {
        border-color: #17a2b8;
        color: #17a2b8;
    }
    .btn-outline-info:hover {
        background-color: #17a2b8;
        color: white;
    }
    #macTable th {
        position: sticky;
        top: 0;
    }
    pre {
        white-space: pre-wrap;
        word-wrap: break-word;
    }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(document).ready(function() {
    // Refresh button
    $('#refreshBtn').click(function() {
        location.reload();
    });
    
    // Check MAC status
    $('#checkMacBtn').click(function() {
        const mac = $('#mac').val().trim();
        if (!mac) {
            alert('Please enter a MAC address to check');
            return;
        }
        
        $.get(`/api/check-mac/${mac}`, function(data) {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                const statusText = data.is_blocked ? 
                    `MAC ${data.mac} is BLOCKED` : 
                    `MAC ${data.mac} is NOT blocked`;
                const statusClass = data.is_blocked ? 'text-danger' : 'text-success';
                
                $('#blockForm').before(`
                    <div class="alert ${statusClass} alert-dismissible fade show mb-3">
                        ${statusText}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `);
            }
        }).fail(function() {
            alert('Error checking MAC status');
        });
    });
    
    // Confirm before unblocking
    $('.unblock-form').submit(function(e) {
        const mac = $(this).find('input[name="mac"]').val();
        if (!confirm(`Are you sure you want to unblock ${mac}?`)) {
            e.preventDefault();
        }
    });
    
    // View iptables rules
    $('.view-rules-btn').click(function() {
        const mac = $(this).data('mac');
        $('#modalMac').text(mac);
        
        $.get(`/api/get-iptables-rules?mac=${encodeURIComponent(mac)}`, function(data) {
            $('#rulesContent').text(data.rules || 'No rules found for this MAC');
        }).fail(function() {
            $('#rulesContent').text('Error loading rules');
        });
        
        $('#rulesModal').modal('show');
    });
    
    // MAC address input formatting
    $('#mac').on('blur', function() {
        let mac = $(this).val().trim().toUpperCase();
        // Try to normalize the format
        mac = mac.replace(/[^0-9A-F]/g, '');
        if (mac.length === 12) {
            $(this).val(mac.match(/.{2}/g).join(':'));
        }
    });
    
    // Search functionality
    $('#searchInput').keyup(function() {
        const value = $(this).val().toLowerCase();
        $('#macTable tbody tr').filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
        });
    });
});
</script>
{% endblock %}
